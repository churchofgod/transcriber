<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Video Transcription</title>
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/js-cookie@beta/dist/js.cookie.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script> 
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.hotkeys@0.1.0/jquery.hotkeys.min.js"></script>    
	<script src="https://global.localizecdn.com/localize.js"></script>
	<script>!function(a){if(!a.Localize){a.Localize={};for(var e=["translate","untranslate","phrase","initialize","translatePage","setLanguage","getLanguage","detectLanguage","getAvailableLanguages","untranslatePage","bootstrap","prefetch","on","off","hideWidget","showWidget"],t=0;t<e.length;t++)a.Localize[e[t]]=function(){}}}(window);</script>
	<script>
	Localize.initialize({
	  key: 'e2mGGl5saCpAt',
	  rememberLanguage: true
	});
	</script>
</head>
<body>
	<div id="nav"></div>
	<div class="container" style="margin-top:4em;">
		<h1>Transcription</h1>
		<div id="video" title="Video Source" >
            <span id="video_display_text"></span>		
			<div class="input-group">
			  <div class="input-group-prepend">
			    <span class="input-group-text"><i class="material-icons">watch_later</i></span>
			    <span id="clockUI" class="input-group-text">00:00</span>
			  </div>
			  <input type="text" class="form-control" id="translation_input" aria-label="Text input with segmented dropdown button">
			  <div class="input-group-append">
			    <button type="button" data-lang="ZH" id="currentTranslation_submit" class="btn btn-primary">Submit<span id="current_lang_button">(ZH)</span></button>
			    <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
			      <span class="sr-only">Toggle Dropdown</span>
			    </button>
			    <div class="dropdown-menu" >
			      <a class="dropdown-item data_lang_select_btn" id="data_lang_zh" data-lang="ZH">Chinese</a>
			      <a class="dropdown-item data_lang_select_btn" id="data_lang_en" data-lang="EN">English</a>
			    </div>
			  </div>
			</div>
            <video id="transcription_video_player" controls style="width: 100%;"></video>
		</div>
		<table id="transcription" class="table table-striped thead-dark col-md-12">
			<thead class="">
				<tr>
					<td>Start Time</td>
					<td>End Time</td>
					<td>Text</td>
					<td>Language</td>
				</tr>
			</thead>
			<tbody class=""></tbody>
		</table>
	</div>
</body>
<style>
	.dropdown-menu{
		left: -10px !important;
	}
	.no-close .ui-dialog-titlebar-close {
	  display: none;
	}
</style>
<script>
	const urlParams = new URLSearchParams(window.location.search);
	const url = urlParams.get('url');	
	let store = {}
		store.data = []
		store._meta = {}
		store._meta.url = url
	var videoLib = function(el, onLoadCallback, onplayingCallbacks, onseekingCallback){
	    let timers = []
	    el.onplaying = function(){
	        for (let callbackObj of onplayingCallbacks) {
	            let timer = setInterval(function(){
	                callbackObj.callback(el.currentTime)
	            }, callbackObj.ms)
	            timers.push(timer)
	        }
	    }
	    el.onpause = function(){
	        for (let timer of timers) {
	            clearInterval(timer)
	        }
	    }
	    el.onseeking = function() {
	        onseekingCallback(el.currentTime, 0)
	    }

	    el.onloadedmetadata = function() {
	        onLoadCallback(el.duration)
	    }
	}	
	var makeid = function(length) {
	   var result           = '';
	   var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
	   var charactersLength = characters.length;
	   for ( var i = 0; i < length; i++ ) {
	      result += characters.charAt(Math.floor(Math.random() * charactersLength));
	   }
	   return result;
	}
	var toHHMMSS = (secs) => {
	    var sec_num = parseInt(secs, 10)
	    var hours   = Math.floor(sec_num / 3600)
	    var minutes = Math.floor(sec_num / 60) % 60
	    var seconds = sec_num % 60

	    return [hours,minutes,seconds]
	        .map(v => v < 10 ? "0" + v : v)
	        .filter((v,i) => v !== "00" || i > 0)
	        .join(":")
	}
	$(document).ready(function($){
   		$( "#video" ).dialog({
  			dialogClass: "no-close",
   			width: 600, height: 450});
		let currentTranslation = {}
		let videoClock = 0
    	let template = {}
    		template.transcription_table_render = function(translations){
    			$('#transcription tbody').html()
	        	$('#transcription tbody').html(_.map(translations, function(e){
    				return `
					<tr id="${e.id}">
						<td>${toHHMMSS(e.start_time)}</td>
						<td>${toHHMMSS(e.end_time)}</td>
						<td>${e.text}</td>
						<td>${e.lang}</td>
					</tr>
		    	`
    			}).join(''))			
    		}
		//control
		$('.data_lang_select_btn').on('click', function(e){
			$('#currentTranslation_submit').attr('data-lang', $(this).attr('data-lang'))
			$('#current_lang_button').text(`(${$(this).attr('data-lang')})`)
		})
		$('#currentTranslation_submit').on('click', function(e){
			currentTranslation.id = makeid(5)
			currentTranslation.lang = $(this).attr('data-lang')
 			store.data = [...store.data, currentTranslation]
 			console.log(store)
     		template.transcription_table_render(store.data)
			currentTranslation = {}
			currentTranslation.start_time = videoClock
			currentTranslation.end_time = videoClock
			$('#translation_input').val('')
		})
		$('#translation_input').on('keyup', function(e){
			e.preventDefault()
			currentTranslation.text = e.target.value
		})
		//video 
		$('#transcription_video_player').append(`<source src="${url}" type="video/mp4">`)
		let videoElement = document.getElementById('transcription_video_player')
		let updateClockUI = function(e){$("#clockUI").text(toHHMMSS(e))}
		let onLoadCallback = function(e){currentTranslation.start_time = 0; currentTranslation.end_time = 0}
		let onplayingCallbacks = [
			{callback: function(e){currentTranslation.end_time = e}, ms: 25},
			{callback: function(e){videoClock = e}, ms: 25},
			{callback: updateClockUI, ms:1000}
		]
		let onseekingCallback = function(e){currentTranslation.start_time = e}
    	videoLib(videoElement, onLoadCallback, onplayingCallbacks, onseekingCallback)
	})
</script>
</html>